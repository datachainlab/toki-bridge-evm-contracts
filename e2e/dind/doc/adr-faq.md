---
# Why dind?

e2e 環境は各コンテナから構成され、各コンテナそれぞれに volume や実行時パラメータがある。
今回の用途からすると、それぞれ個別管理してもらうよりも一式として扱う方が良いと判断。

一式まとめる方法もいくつかある:

 * VM化
   プロセスも固められて良いのだが、現e2e の資産の流用ができないので開発工数が多い。

 * docker compose, kubernetes
   volume やランタイムに渡すファイル、初期化処理などをポータブルな形に作るのが大変そう。

 * dind
   ローカル --data-dir にすれば docker volume などそのままイメージ化できそうなので、現行 e2e から少ない手間で実現可能そう。
   (プロセス固定化できないので起動スクリプト整備の必要があって実際は大変だったが)

 * tar や zip に固める
   docker volume をファイルとして扱うのが困難。
   というか dind にして docker save するのとあまり変わらない。
   そもそも共有のためのコンテナレジストリなどある現代でアーカイブファイル使うのはどうなのか。

 * docker checkpoint
   プロセスも固められそうだが、experimental だし、他人のマシンに持っていけるか不明。
   検証に時間かかる上、使えませんとなるリスクが高い。

当初見積もりでは dind がリスク*工数が少なさそうなので dind 採用。



---
# ホスト(L1) での container registry

dind コンテナ(L2)上でコンテナを起動するため、dind 上の docker --data-root に image が必要。
これを実現する方法はいくつかある:

  * a. L1 上のイメージを利用
     通常の dind コンテナは L1 の /var/lib/docker を volume マウントするので、この形になる。
     - pros:
       速い。余計な容量も食わない。
     - cons:
       今回は L2 で volume 使いたかったので L2 内のローカルファイルを --data-root として利用してるので使えない。
       (image 領域だけホストボリューム使えれば可能だが試してない)

  * b. L2 上でイメージビルドする
     - pros:
       L2 内で完結するのでポータビリティが上がる。
     - conss:
       L2 ストレージが汚れてコンテナサイズが増える。
       L2 イメージを作り直すときにビルドしなおしになる。

  * c. L1 からもらってくる
     - pros:
       L1->L2 の通信が発生するが、b の再ビルドよりはマシ。
       また、外部のコンテナレジストリから持ってくる形にもスムーズに対応できる。
     - cons:
       L1 にコンテナレジストリを立てる必要がある。

それぞれの pros/cons を比較し、今回は c を採用。

---
