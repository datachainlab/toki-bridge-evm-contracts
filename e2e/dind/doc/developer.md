# 目的
app contract を使うアプリケーションのテストを考えると、コントラクトの状態を戻したいケースがある。
このレポジトリの e2e/ でテスト環境は提供しているが、コントラクトのデプロイやデポジットなどを毎回行う必要がある。
これには時間がかかる。

そこで、コントラクトデプロイ済みの状態を保存しておき、それを復元することで時間を短縮する方法を提供する。

# アーキテクチャ
状態保存の技術として、docker commit でイメージ化を採用した。

e2e ではブロックチェーンノードなど複数のコンテナが動作する。
これらをまとめて一つのイメージにするため、docker-in-docker イメージ上で e2e コンテナ群を動かす。
dind コンテナを commit でイメージ化する。

混乱するので、以下のように名前を付ける:
 - 1層(L1): dind イメージの実行や commit を行うホスト
 - 2層(L2): dind コンテナ
 - 3層(L3): blockchain node など、dind 上で動く各コンテナ

docker commit はコンテナ実行中のストレージ状態を保存するもので、プロセスは保存されない。
commit イメージを起動すると、普通に entrypoint が走る。
このような仕組みのため、前回のプロセス状態を復旧できる entrypoint スクリプトを書く必要がある。

具体的には、以下のようなイメージ作成のプロセスを実施する。
 1. ベースとなるコンテナイメージを作る。
 2. run し、デプロイなどの実行時処理を実行する。
 3. 再生可能な形でプロセスを停止する。
 4. docker commit.

あとは、状態をリセットしたい時に commit イメージを run しなおせばよい。

# 要件分析
今回の保存状態の対象はコントラクトデプロイ〜deposit があればよいが、様々な状態を保存したくなることは推測される。
そこで、段階的にイメージを作成できるような構成とする。

docker-in-docker の /var/lib/docker 領域を保存するために、dind 上のファイルを loopback マウントする。
どうもこの loopback は実際の使用量の数倍を消費し、さらに commit のたびに増加するようである。
段階的に構成可能とするが、実行不要であれば commit しないイメージをベースに拡張する。

# 構成
dind/ 以下に各ステージ用のディレクトリを作る。
名前は、後で説明する連番が分かりやすい。

Makefile を用意する。
共通の処理にできる部分は dind/common.mk に置き、include する。

ベースイメージを作る処理に必要なファイル(Dockerfile など)は、l1/ に置く。
イメージに含まれるファイルは l2/ に置く。

## ENTRYPOINT
上で見たように、commit 前にプロセスを終了する。
PID=1 を止めるとコンテナが終了してしまうので、具体的なプロセスと PID=1 は分離する必要がある。

## init.sh と entrypoint.sh
ENTRYPOINT から起動時に呼ばれる処理と、commit 前に呼ばれる停止処理が必要。
段階処理を考えると、スクリプトは複数になる。

起動/終了で関連した処理になるので、一つのスクリプトファイルにまとめる。
引数 start で起動処理、stop で終了処理を行う形式で。

あとは、これらスクリプト群を順番に実行するスクリプトが必要。
init.sh と名付ける。
`init.sh start` で、init.d/ 以下のスクリプトを順に実行。
`init.sh stop` で、逆順に実行する。

ENTRYPOINT 用に entrypoint.sh を用意。
`init.sh start` を実行する。
`init.sh stop` を呼ぶ機構も必要。
`docker exec init.sh stop` してもらっても良いが、start 呼んでる entrypoint.sh 内にまとめるのが良い。
SIGUSR1 で `init.sh stop` するようにする。

## init.d スクリプト
init.sh がこのディレクトリにあるスクリプトを順に実行する。
Dockefile でここに配置する。

実行対象および順番は具体的には `find . -type f -executable -maxdepth 1 -name "*.sh" | sort`

ほとんどはステージ順に行うだろう。
ステージ毎に固有のプレフィクスを用意し、それを init スクリプトのファイル名に付けておく。
次ステージは前ステージよりも後になるプレフィクスを使う。
分かりやすくするため、dind/ 以下のディレクトリ名にそれを使うのを推奨。

## Makefile

- image
  commit したイメージを作るターゲット。
  最終的なステージにだけあればよいが、単体でも動かせるように用意しておくのが望ましい。

- tmp-image
  docker build するターゲット。
  commit 前にはここで作るイメージを run する。
  また、各段階の Dockerfile は、前段階の tmp-image を FROM で参照する。

- run
  image を docker run するターゲット。
  パラメータ以外は共通な処理なので common.mk にある。

- commit
  tmp-image を run して処理した後、commit するための手順は共通になので common.mk にある。
  image ターゲットは、実行時処理後に commit イメージ作るときにこれを呼ぶとよい。

